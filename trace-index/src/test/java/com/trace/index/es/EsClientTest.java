package com.trace.index.es;

import java.util.ArrayList;
import java.util.List;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;

import com.eson.common.core.util.JsonUtils;
import com.trace.common.domain.IndexLog;
import com.trace.common.domain.IndexSpan;
import com.trace.index.BaseTest;

/**
 * @author dengxiaolin
 * @since 2021/02/07
 */
public class EsClientTest extends BaseTest {
    @Autowired
    private EsClient esClient;

    @Test
    void bulkTestSpans() {
        List<IndexSpan> indexSpanList = new ArrayList<>();
        indexSpanList.addAll(JsonUtils.parseList("[{\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"name\":\"ProductController.test\",\"id\":\"0\",\"depth\":1,\"appKey\":\"dubbo-consumer-demo\",\"ip\":\"172.25.163.35\",\"start\":1619161206479,\"end\":1619161209566,\"cost\":3087,\"serviceType\":\"http\",\"status\":\"success\",\"tagMap\":{\"httpPath\":\"/test/dubbo/test\",\"httpMethod\":\"GET\",\"httpUrl\":\"/test/dubbo/test\"}},{\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"name\":\"Test.test\",\"id\":\"0.1\",\"depth\":2,\"appKey\":\"dubbo-consumer-demo\",\"ip\":\"172.25.163.35\",\"start\":1619161206502,\"end\":1619161206513,\"cost\":11,\"serviceType\":\"inner-call\",\"status\":\"success\"},{\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"name\":\"ProductService.sayHello\",\"id\":\"0.2\",\"depth\":2,\"appKey\":\"dubbo-consumer-demo\",\"ip\":\"172.25.163.35\",\"start\":1619161206523,\"end\":1619161209540,\"cost\":3017,\"serviceType\":\"duubo-c\",\"errorMessage\":\"[\\\"com.dubbo.example.product.service.ProductService.sayHello : ArrayIndexOutOfBoundsException\\\"]\",\"status\":\"failed\"}] \n", IndexSpan.class));

        indexSpanList.addAll(JsonUtils.parseList("[{\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"name\":\"ProductService.sayHello\",\"id\":\"0.2.1\",\"depth\":3,\"clientAppKey\":\"dubbo-consumer-demo\",\"clientIp\":\"172.25.163.35\",\"appKey\":\"dubbo-provider-demo\",\"ip\":\"172.25.163.35\",\"start\":1619161206541,\"end\":1619161209524,\"cost\":2983,\"serviceType\":\"dubbo-p\",\"errorMessage\":\"[\\\"java.lang.ArrayIndexOutOfBoundsException: 1\\\",\\\"com.dubbo.example.product.manager.ProductManager.test(ProductManager.java:25)\\\",\\\"com.dubbo.example.product.service.ProductServiceImpl.sayHello(ProductServiceImpl.java:21)\\\"]\",\"status\":\"failed\",\"tagMap\":{\"request\":\"[]\"}},{\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"name\":\"TestMapper.getAll\",\"id\":\"0.2.1.1\",\"depth\":4,\"clientAppKey\":\"dubbo-consumer-demo\",\"clientIp\":\"172.25.163.35\",\"appKey\":\"dubbo-provider-demo\",\"ip\":\"172.25.163.35\",\"start\":1619161209453,\"end\":1619161209510,\"cost\":57,\"serviceType\":\"jdbc\",\"status\":\"success\",\"tagMap\":{\"jdbcRef\":\"jdbc:mysql://10.24.90.86:5002/waimai_agent\",\"sql\":\"select id, name, valid, ctime, utime from wm_agent_test; Total: 19\"}}]\n" +
                "2021/04/23 15:00:10.253 thread-log-collector1  [INFO] ScribeAppender [{\"appKey\":\"dubbo-provider-demo\",\"ip\":\"172.25.163.35\",\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"loggerName\":\"org.apache.dubbo.rpc.filter.ExceptionFilter\",\"thread\":\"DubboServerHandler-172.25.163.35:20880-thread-2\",\"logTime\":1619161209516,\"logDate\":null,\"logLevel\":\"ERROR\",\"message\":\"[\\\"Got unchecked and undeclared exception which called by 172.25.163.35. service: com.dubbo.example.product.service.ProductService, method: sayHello, exception: java.lang.ArrayIndexOutOfBoundsException: 1\\\\njava.lang.ArrayIndexOutOfBoundsException: 1\\\\n\\\\tat com.dubbo.example.product.manager.ProductManager.test(ProductManager.java:25) ~[classes/:?]\\\\n\\\\tat com.dubbo.example.product.service.ProductServiceImpl.sayHello(ProductServiceImpl.java:21) ~[classes/:?]\\\\n\\\\tat org.apache.dubbo.common.bytecode.Wrapper1.invokeMethod(Wrapper1.java) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.proxy.javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:47) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.java:84) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke(DelegateProviderMetaDataInvoker.java:56) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.InvokerWrapper.invoke(InvokerWrapper.java:56) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat com.trace.dubbo.filter.ServiceExceptionFilter.invoke(ServiceExceptionFilter.java:37) ~[trace-dubbo-1.0-SNAPSHOT.jar:?]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.java:89) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.TimeoutFilter.invoke(TimeoutFilter.java:46) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat com.trace.dubbo.filter.TraceDubboProviderFilter.lambda$invoke$0(TraceDubboProviderFilter.java:45) ~[trace-dubbo-1.0-SNAPSHOT.jar:?]\\\\n\\\\tat com.trace.core.manager.TraceManager.invoke(TraceManager.java:87) [?:?]\\\\n\\\\tat com.trace.core.manager.TraceManager.tracingWithReturn(TraceManager.java:35) [?:?]\\\\n\\\\tat com.trace.dubbo.filter.TraceDubboProviderFilter.invoke(TraceDubboProviderFilter.java:40) [trace-dubbo-1.0-SNAPSHOT.jar:?]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.dubbo.filter.TraceFilter.invoke(TraceFilter.java:77) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.ContextFilter.invoke(ContextFilter.java:129) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.GenericFilter.invoke(GenericFilter.java:152) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.ClassLoaderFilter.invoke(ClassLoaderFilter.java:38) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.EchoFilter.invoke(EchoFilter.java:41) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol$1.reply(DubboProtocol.java:145) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.handleRequest(HeaderExchangeHandler.java:100) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.received(HeaderExchangeHandler.java:175) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.transport.DecodeHandler.received(DecodeHandler.java:51) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.transport.dispatcher.ChannelEventRunnable.run(ChannelEventRunnable.java:57) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]\\\\n\\\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]\\\\n\\\\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_172]\\\\n\\\",\\\"com.dubbo.example.product.manager.ProductManager.test(ProductManager.java:25)\\\",\\\"com.dubbo.example.product.service.ProductServiceImpl.sayHello(ProductServiceImpl.java:21)\\\",\\\"org.apache.dubbo.common.bytecode.Wrapper1.invokeMethod(Wrapper1.java)\\\",\\\"org.apache.dubbo.rpc.proxy.javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:47)\\\",\\\"org.apache.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.java:84)\\\",\\\"org.apache.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke(DelegateProviderMetaDataInvoker.java:56)\\\"]\"}]\n", IndexSpan.class));

        esClient.bulkUploadSpans(indexSpanList);
    }


    @Test
    void bulkTestLogs() {
        List<IndexLog> indexLogList = new ArrayList<>();
        indexLogList.addAll(JsonUtils.parseList("[{\"appKey\":\"dubbo-consumer-demo\",\"ip\":\"172.25.163.35\",\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"loggerName\":\"com.dubbo.example.product.controller.Test\",\"thread\":\"http-nio-8416-exec-1\",\"logTime\":1619161206509,\"logDate\":null,\"logLevel\":\"INFO\",\"message\":\"[\\\"test\\\\n\\\"]\"},{\"appKey\":\"dubbo-consumer-demo\",\"ip\":\"172.25.163.35\",\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"loggerName\":\"com.trace.dubbo.filter.TraceDubboConsumerFilter\",\"thread\":\"http-nio-8416-exec-1\",\"logTime\":1619161206524,\"logDate\":null,\"logLevel\":\"INFO\",\"message\":\"[\\\"RequestParam: []\\\\n\\\"]\"}] \n", IndexLog.class));

        indexLogList.addAll(JsonUtils.parseList("[{\"appKey\":\"dubbo-consumer-demo\",\"ip\":\"172.25.163.35\",\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"loggerName\":\"com.trace.dubbo.filter.TraceDubboConsumerFilter\",\"thread\":\"http-nio-8416-exec-1\",\"logTime\":1619161209539,\"logDate\":null,\"logLevel\":\"INFO\",\"message\":\"[\\\"Response: AppResponse [value=null, exception=com.eson.common.core.exception.ServiceException: 1]\\\\n\\\"]\"}] \n", IndexLog.class));
        indexLogList.addAll(JsonUtils.parseList("[{\"appKey\":\"dubbo-provider-demo\",\"ip\":\"172.25.163.35\",\"traceId\":\"f990c119aaa3471f8b4d1e41f102e8d9\",\"loggerName\":\"org.apache.dubbo.rpc.filter.ExceptionFilter\",\"thread\":\"DubboServerHandler-172.25.163.35:20880-thread-2\",\"logTime\":1619161209516,\"logDate\":null,\"logLevel\":\"ERROR\",\"message\":\"[\\\"Got unchecked and undeclared exception which called by 172.25.163.35. service: com.dubbo.example.product.service.ProductService, method: sayHello, exception: java.lang.ArrayIndexOutOfBoundsException: 1\\\\njava.lang.ArrayIndexOutOfBoundsException: 1\\\\n\\\\tat com.dubbo.example.product.manager.ProductManager.test(ProductManager.java:25) ~[classes/:?]\\\\n\\\\tat com.dubbo.example.product.service.ProductServiceImpl.sayHello(ProductServiceImpl.java:21) ~[classes/:?]\\\\n\\\\tat org.apache.dubbo.common.bytecode.Wrapper1.invokeMethod(Wrapper1.java) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.proxy.javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:47) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.java:84) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke(DelegateProviderMetaDataInvoker.java:56) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.InvokerWrapper.invoke(InvokerWrapper.java:56) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat com.trace.dubbo.filter.ServiceExceptionFilter.invoke(ServiceExceptionFilter.java:37) ~[trace-dubbo-1.0-SNAPSHOT.jar:?]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.java:89) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.TimeoutFilter.invoke(TimeoutFilter.java:46) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) ~[dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat com.trace.dubbo.filter.TraceDubboProviderFilter.lambda$invoke$0(TraceDubboProviderFilter.java:45) ~[trace-dubbo-1.0-SNAPSHOT.jar:?]\\\\n\\\\tat com.trace.core.manager.TraceManager.invoke(TraceManager.java:87) [?:?]\\\\n\\\\tat com.trace.core.manager.TraceManager.tracingWithReturn(TraceManager.java:35) [?:?]\\\\n\\\\tat com.trace.dubbo.filter.TraceDubboProviderFilter.invoke(TraceDubboProviderFilter.java:40) [trace-dubbo-1.0-SNAPSHOT.jar:?]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.dubbo.filter.TraceFilter.invoke(TraceFilter.java:77) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.ContextFilter.invoke(ContextFilter.java:129) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.GenericFilter.invoke(GenericFilter.java:152) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.ClassLoaderFilter.invoke(ClassLoaderFilter.java:38) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.filter.EchoFilter.invoke(EchoFilter.java:41) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol$1.reply(DubboProtocol.java:145) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.handleRequest(HeaderExchangeHandler.java:100) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.received(HeaderExchangeHandler.java:175) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.transport.DecodeHandler.received(DecodeHandler.java:51) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat org.apache.dubbo.remoting.transport.dispatcher.ChannelEventRunnable.run(ChannelEventRunnable.java:57) [dubbo-2.7.8.jar:2.7.8]\\\\n\\\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]\\\\n\\\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]\\\\n\\\\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_172]\\\\n\\\",\\\"com.dubbo.example.product.manager.ProductManager.test(ProductManager.java:25)\\\",\\\"com.dubbo.example.product.service.ProductServiceImpl.sayHello(ProductServiceImpl.java:21)\\\",\\\"org.apache.dubbo.common.bytecode.Wrapper1.invokeMethod(Wrapper1.java)\\\",\\\"org.apache.dubbo.rpc.proxy.javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:47)\\\",\\\"org.apache.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.java:84)\\\",\\\"org.apache.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke(DelegateProviderMetaDataInvoker.java:56)\\\"]\"}]\n", IndexLog.class));

        esClient.bulkUploadLogs(indexLogList);
    }
}
